<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epoch Server Status Monitor</title>
    <style>
        body { background-color: #1a1a2e; color: #e0e0e0; font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; text-align: center; }
        .container { padding: 40px; background-color: #16213e; border-radius: 15px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3); min-width: 300px; }
        h1 { color: #0f3460; margin-top: 0; }
        #status-container { margin-top: 20px; text-align: left; }
        .status-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #2a3a5e; }
        .status-row:last-child { border-bottom: none; }

        /* --- CHANGE 1: Added colors for Up/Down statuses --- */
        .up { color: #28a745; font-weight: bold; } /* Green */
        .down { color: #ff5555; font-weight: bold; } /* Red */
        .unknown { color: #aaa; } /* Grey for unknown status */

        button { background-color: #e94560; color: white; border: none; padding: 10px 15px; border-radius: 5px; font-size: 1rem; cursor: pointer; margin-top: 20px; transition: background-color 0.3s; }
        button:disabled { background-color: #28a745; cursor: not-allowed; }

        /* --- CHANGE 2: Style for the new footer text --- */
        .footer-text {
            font-size: 0.8rem;
            color: #aaa;
            margin-top: 30px;
        }
        .footer-text a {
            color: #e94560;
            text-decoration: none;
        }
        .footer-text a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Epoch Server Status</h1>
        <div id="status-container"><p>Loading status...</p></div>
        <button id="notify-btn">Enable Notifications</button>

        <!-- --- CHANGE 2: Added affiliation footer with hyperlink --- -->
        <p class="footer-text">
            Not Affiliated with <a href="https://www.project-epoch.net/" target="_blank" rel="noopener noreferrer">Project Epoch</a>
        </p>
    </div>

    <script>
        const statusContainer = document.getElementById('status-container');
        const notifyBtn = document.getElementById('notify-btn');

        // This function now correctly applies 'up' or 'down' as a class
        function renderStatuses(statuses) {
            if (!statuses || statuses.length === 0) {
                statusContainer.innerHTML = '<p>Status not available yet.</p>';
                return;
            }
            statusContainer.innerHTML = '';
            statuses.forEach(server => {
                const statusClass = server.status.toLowerCase();
                statusContainer.innerHTML += `
                    <div class="status-row">
                        <span>${server.name}</span>
                        <span class="${statusClass}">${server.status}</span>
                    </div>
                `;
            });
        }

        function showNotification(title, options) {
            if (Notification.permission === 'granted') {
                new Notification(title, options);
            }
        }

        // --- CHANGE 3: Logic to change button when notifications are enabled ---
        notifyBtn.addEventListener('click', () => {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    console.log('Notification permission granted.');
                    notifyBtn.textContent = 'Notifications Enabled';
                    notifyBtn.disabled = true; // This will trigger the green color via the CSS :disabled state

                    showNotification('Notifications Enabled', { body: 'You will now be alerted of server status changes.' });
                }
            });
        });

        fetch('/api/initial-status')
            .then(res => res.json())
            .then(renderStatuses);

        const eventSource = new EventSource('/events');

        eventSource.onmessage = (event) => {
            const data = JSON.parse(event.data);
            
            if (data.type === 'STATUS_CHANGE') {
                console.log('Received status change from server:', data);
                renderStatuses(data.payload);

                const oldStatuses = data.oldPayload;
                const newStatuses = data.payload;
                let changes = [];

                newStatuses.forEach(newServer => {
                    const oldServer = oldStatuses.find(s => s.name === newServer.name);
                    if (oldServer && oldServer.status !== newServer.status) {
                        changes.push(`${newServer.name} is now ${newServer.status}`);
                    }
                });

                if (changes.length > 0) {
                    showNotification('Epoch Server Status Changed!', {
                        body: changes.join('\n'),
                        icon: 'https://cdn-icons-png.flaticon.com/512/1004/1004735.png'
                    });
                }
            }
        };

        eventSource.onerror = (err) => {
            console.error('EventSource failed:', err);
            statusContainer.innerHTML = '<p style="color:#ff5555;">Lost connection to the server. Please refresh.</p>';
        };
    </script>
</body>
</html>