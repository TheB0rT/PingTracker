<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epoch Server Status Monitor</title>
    <style>
        body { background-color: #1a1a2e; color: #e0e0e0; font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; text-align: center; }
        
        /* --- NEW: This wrapper will stack the logo and the status box vertically --- */
        #main-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container { padding: 40px; background-color: #16213e; border-radius: 15px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3); min-width: 300px; }
        
        /* The logo is no longer constrained by the container's padding */
        #logo {
            max-width: 500px; /* Adjust size as needed */
            width: 90%;
            height: auto;
            margin-bottom: 25px; /* Creates space between logo and status box */
        }

        #status-container { margin-top: 20px; text-align: left; }
        .status-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #2a3a5e; }
        .status-row:last-child { border-bottom: none; }
        
        .up { color: #28a745; font-weight: bold; }
        .down { color: #ff5555; font-weight: bold; }
        .unknown { color: #aaa; }

        button { background-color: #e94560; color: white; border: none; padding: 10px 15px; border-radius: 5px; font-size: 1rem; cursor: pointer; margin-top: 20px; transition: background-color 0.3s; }
        button:disabled { background-color: #28a745; cursor: not-allowed; }
        button.denied:disabled { background-color: #6c757d; }

        .footer-text { font-size: 0.8rem; color: #aaa; margin-top: 30px; }
        .footer-text a { color: #e94560; text-decoration: none; }
        .footer-text a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <!-- --- NEW: A main wrapper to hold the logo and the container separately --- -->
    <div id="main-wrapper">
        <!-- The logo is now outside the container/frame -->
        <img id="logo" src="https://www.project-epoch.net/img/global/full-logo.webp" alt="Project Epoch Logo">

        <!-- The container now only holds the status info -->
        <div class="container">
            <div id="status-container"><p>Loading status...</p></div>
            <button id="notify-btn">Enable Notifications</button>
            <p class="footer-text">
                Made possible by the <a href="https://epoch.strykersoft.us/" target="_blank" rel="noopener noreferrer">status page</a> from <a href="https://www.reddit.com/user/stryker2k2/" target="_blank" rel="noopener noreferrer">@stryker2k2</a>
                <br>Not affiliated with <a href="https://www.project-epoch.net/" target="_blank" rel="noopener noreferrer">Project Epoch</a>
            </p>
        </div>
    </div>

    <script>
        const statusContainer = document.getElementById('status-container');
        const notifyBtn = document.getElementById('notify-btn');

        function renderStatuses(statuses) {
            if (!statuses || statuses.length === 0) {
                statusContainer.innerHTML = '<p>Status not available yet.</p>';
                return;
            }
            statusContainer.innerHTML = '';
            statuses.forEach(server => {
                const statusClass = server.status.toLowerCase();
                statusContainer.innerHTML += `
                    <div class="status-row">
                        <span>${server.name}</span>
                        <span class="${statusClass}">${server.status}</span>
                    </div>
                `;
            });
        }

        function showNotification(title, options) {
            if (Notification.permission === 'granted') {
                new Notification(title, options);
            }
        }

        function updateButtonState(state) {
            notifyBtn.classList.remove('denied');
            if (state === 'granted') {
                notifyBtn.textContent = 'Notifications Enabled';
                notifyBtn.disabled = true;
            } else if (state === 'denied') {
                notifyBtn.textContent = 'Notifications Blocked';
                notifyBtn.disabled = true;
                notifyBtn.classList.add('denied');
            } else {
                notifyBtn.textContent = 'Enable Notifications';
                notifyBtn.disabled = false;
            }
        }

        if ('permissions' in navigator) {
            navigator.permissions.query({name: 'notifications'}).then(permissionStatus => {
                updateButtonState(permissionStatus.state);
                permissionStatus.onchange = () => {
                    updateButtonState(permissionStatus.state);
                };
            });
        } else {
            updateButtonState(Notification.permission);
        }

        notifyBtn.addEventListener('click', () => {
            Notification.requestPermission();
        });

        fetch('/api/initial-status')
            .then(res => res.json())
            .then(renderStatuses);

        const eventSource = new EventSource('/events');

        eventSource.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'STATUS_CHANGE') {
                renderStatuses(data.payload);
                const oldStatuses = data.oldPayload;
                const newStatuses = data.payload;
                let changes = [];
                newStatuses.forEach(newServer => {
                    const oldServer = oldStatuses.find(s => s.name === newServer.name);
                    if (oldServer && oldServer.status !== newServer.status) {
                        changes.push(`${newServer.name} is now ${newServer.status}`);
                    }
                });
                if (changes.length > 0) {
                    showNotification('Epoch Server Status Changed!', {
                        body: changes.join('\n'),
                        icon: 'https://cdn-icons-png.flaticon.com/512/1004/1004735.png'
                    });
                }
            }
        };

        eventSource.onerror = (err) => {
            console.error('EventSource failed:', err);
            statusContainer.innerHTML = '<p style="color:#ff5555;">Lost connection to the server. Please refresh.</p>';
        };
    </script>
</body>
</html>