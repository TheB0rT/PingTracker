<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epoch Server Status Monitor</title>
    <style>
        body { background-color: #1a1a2e; color: #e0e0e0; font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; text-align: center; }
        .container { padding: 40px; background-color: #16213e; border-radius: 15px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3); min-width: 300px; }
        h1 { color: #0f3460; margin-top: 0; }
        #status-container { margin-top: 20px; text-align: left; }
        .status-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #2a3a5e; }
        .status-row:last-child { border-bottom: none; }
        
        .up { color: #28a745; font-weight: bold; }
        .down { color: #ff5555; font-weight: bold; }
        .unknown { color: #aaa; }

        button { background-color: #e94560; color: white; border: none; padding: 10px 15px; border-radius: 5px; font-size: 1rem; cursor: pointer; margin-top: 20px; transition: background-color 0.3s; }
        /* When the button is disabled, it will be green (for 'granted') or grey (for 'denied') */
        button:disabled { background-color: #28a745; cursor: not-allowed; }
        button.denied:disabled { background-color: #6c757d; } /* Grey for blocked */

        .footer-text { font-size: 0.8rem; color: #aaa; margin-top: 30px; }
        .footer-text a { color: #e94560; text-decoration: none; }
        .footer-text a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Epoch Server Status</h1>
        <div id="status-container"><p>Loading status...</p></div>
        <button id="notify-btn">Enable Notifications</button>
        <p class="footer-text">
            Not Affiliated with <a href="https://www.project-epoch.net/" target="_blank" rel="noopener noreferrer">Project Epoch</a>
        </p>
    </div>

    <script>
        const statusContainer = document.getElementById('status-container');
        const notifyBtn = document.getElementById('notify-btn');

        function renderStatuses(statuses) {
            if (!statuses || statuses.length === 0) {
                statusContainer.innerHTML = '<p>Status not available yet.</p>';
                return;
            }
            statusContainer.innerHTML = '';
            statuses.forEach(server => {
                const statusClass = server.status.toLowerCase();
                statusContainer.innerHTML += `
                    <div class="status-row">
                        <span>${server.name}</span>
                        <span class="${statusClass}">${server.status}</span>
                    </div>
                `;
            });
        }

        function showNotification(title, options) {
            if (Notification.permission === 'granted') {
                new Notification(title, options);
            }
        }

        // --- NEW: A single function to update the button's appearance based on permission state ---
        function updateButtonState(state) {
            notifyBtn.classList.remove('denied');
            if (state === 'granted') {
                notifyBtn.textContent = 'Notifications Enabled';
                notifyBtn.disabled = true;
            } else if (state === 'denied') {
                notifyBtn.textContent = 'Notifications Blocked';
                notifyBtn.disabled = true;
                notifyBtn.classList.add('denied');
            } else {
                notifyBtn.textContent = 'Enable Notifications';
                notifyBtn.disabled = false;
            }
        }

        // --- NEW: This block handles all permission logic ---
        // It checks the state on load and listens for any changes.
        if ('permissions' in navigator) {
            navigator.permissions.query({name: 'notifications'}).then(permissionStatus => {
                // 1. Set the initial state of the button when the page loads
                updateButtonState(permissionStatus.state);

                // 2. Listen for any changes to the permission
                permissionStatus.onchange = () => {
                    updateButtonState(permissionStatus.state);
                };
            });
        } else {
            // Fallback for older browsers: just check the permission on load.
            updateButtonState(Notification.permission);
        }

        // The click listener is now simpler: it just asks for permission.
        // The 'onchange' event above will handle the result.
        notifyBtn.addEventListener('click', () => {
            Notification.requestPermission();
        });

        // --- The rest of the script is unchanged ---
        fetch('/api/initial-status')
            .then(res => res.json())
            .then(renderStatuses);

        const eventSource = new EventSource('/events');

        eventSource.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'STATUS_CHANGE') {
                renderStatuses(data.payload);
                // ... notification logic ...
            }
        };

        eventSource.onerror = (err) => {
            console.error('EventSource failed:', err);
            statusContainer.innerHTML = '<p style="color:#ff5555;">Lost connection to the server. Please refresh.</p>';
        };
    </script>
</body>
</html>